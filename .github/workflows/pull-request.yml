name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
  pull_request_target:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  # VÃ©rifications de code
  code-quality:
    name: QualitÃ© du Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: VÃ©rification ESLint
        run: npm run lint

      - name: VÃ©rification Prettier
        run: npx prettier --check .

      - name: VÃ©rification TypeScript
        run: npm run type-check

      - name: VÃ©rification des imports
        run: npx import-sort --check .

  # Tests automatisÃ©s
  tests:
    name: Tests AutomatisÃ©s
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: Tests unitaires
        run: npm run test

      - name: Tests d'intÃ©gration
        run: npm run test:integration

      - name: Couverture de code
        run: npm run test:coverage

      - name: Upload de la couverture
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # VÃ©rifications de sÃ©curitÃ©
  security:
    name: SÃ©curitÃ©
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: Audit de sÃ©curitÃ© npm
        run: npm audit --audit-level moderate

      - name: Scan des vulnÃ©rabilitÃ©s
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Scan des secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          base: ${{ github.event.pull_request.base.sha }}

  # Build et vÃ©rifications
  build:
    name: Build et VÃ©rifications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: Build de l'application
        run: npm run build

      - name: VÃ©rification de la taille du bundle
        run: |
          # VÃ©rifier la taille du build
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "Taille du build: $BUILD_SIZE"
          
          # Avertir si le build est trop gros
          if [ "$BUILD_SIZE" > "50M" ]; then
            echo "âš ï¸  Le build semble volumineux"
          fi

  # Tests de base de donnÃ©es
  database:
    name: Tests Base de DonnÃ©es
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: GÃ©nÃ©ration du client Prisma
        run: npm run db:generate

      - name: Migration de la base de donnÃ©es
        run: npm run db:push

      - name: Tests des scripts de base de donnÃ©es
        run: |
          node scripts/test-event-repertoire.js
          node scripts/test-repertoire-apis.js
          node scripts/test-admin-availability.js
          node scripts/test-admin-apis-server.js

  # VÃ©rifications de performance
  performance:
    name: VÃ©rifications Performance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: Build de l'application
        run: npm run build

      - name: Analyse de performance
        run: |
          # VÃ©rifier les imports non utilisÃ©s
          npx unimported
          
          # VÃ©rifier les dÃ©pendances
          npx depcheck

  # Commentaire sur la PR
  pr-comment:
    name: Commentaire PR
    runs-on: ubuntu-latest
    needs: [code-quality, tests, security, build, database, performance]
    if: always()

    steps:
      - name: Commentaire de rÃ©sumÃ©
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## RÃ©sumÃ© de la PR')
            );

            const summary = `
            ## RÃ©sumÃ© de la PR

            ### âœ… VÃ©rifications rÃ©ussies
            ${needs.code-quality.result === 'success' ? '- âœ… QualitÃ© du code' : '- âŒ QualitÃ© du code'}
            ${needs.tests.result === 'success' ? '- âœ… Tests automatisÃ©s' : '- âŒ Tests automatisÃ©s'}
            ${needs.security.result === 'success' ? '- âœ… SÃ©curitÃ©' : '- âŒ SÃ©curitÃ©'}
            ${needs.build.result === 'success' ? '- âœ… Build' : '- âŒ Build'}
            ${needs.database.result === 'success' ? '- âœ… Base de donnÃ©es' : '- âŒ Base de donnÃ©es'}
            ${needs.performance.result === 'success' ? '- âœ… Performance' : '- âŒ Performance'}

            ### ğŸ“Š MÃ©triques
            - **Taille du build**: ${needs.build.result === 'success' ? 'âœ… OK' : 'âŒ Ã‰chec'}
            - **Couverture de tests**: ${needs.tests.result === 'success' ? 'âœ… OK' : 'âŒ Ã‰chec'}
            - **VulnÃ©rabilitÃ©s**: ${needs.security.result === 'success' ? 'âœ… Aucune' : 'âŒ DÃ©tectÃ©es'}

            ### ğŸš€ PrÃªt pour le merge
            ${needs.code-quality.result === 'success' && 
              needs.tests.result === 'success' && 
              needs.security.result === 'success' && 
              needs.build.result === 'success' ? 
              'âœ… **Cette PR est prÃªte pour le merge!**' : 
              'âŒ **Cette PR nÃ©cessite des corrections avant le merge.**'
            }
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
